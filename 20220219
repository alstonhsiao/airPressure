
// ----------LIBRARIES--------------
#include <ESP8266WiFi.h>
#include <WiFiClientSecure.h>

//========================================
// --------CONSTANTS (won't change)---------------


//const int onBoardLedPin =  13;      // the pin numbers for the LEDs
long fakePressure=0;


//========================================
//------------ VARIABLES (will change)---------------------

unsigned long pressure = 0;
unsigned long currentMillis = 0;    // stores the value of millis() in each iteration of loop()
unsigned long previousPressureMillis = 0;
unsigned long pressureInterval = 10000; //1000=1s
unsigned long previousSendGoogle = 0;
unsigned long sendGoogleInterval = 90000;//60s=60000


// --------Wifi data subroutine ---------------


char _lwifi_ssid[] = "Standtools_office";//wifi SSID
char _lwifi_pass[] = "12345678"; //wifi password
void wifiSetting() {
 WiFi.begin(_lwifi_ssid, _lwifi_pass);
 while (WiFi.status() != WL_CONNECTED) { delay(500); }
 delay(300);
}

const char* asId="AKfycbyR-Yp-uu4nIvnjvnkILaQ5AX8yFxp-UpBO-Sqs0su3ai1N_BvQsz_Q";
String sheetId="";
String sheetTag="";


// --------google sheet data subroutine--------------- only happen once on void Setup()


void googleSheetSetting() {
 sheetId="11uiCoNE0y5-pEqA26k_5unUDaY8NhDbZnYxmQXVZQCs"; //google sheet ID
 sheetTag=URLEncode("airPresure"); //google sheet tag
 sendToGoogleSheets("0",URLEncode((String() + "Time&Date" + "," + "Presure").c_str())); //send table setting
 delay(1000);
}

void sendToGoogleSheets(const String& dateInclude,const String& data) //don't do anything below
{
 static WiFiClientSecure sheetClient;
 sheetClient.setInsecure();
 const char* host="script.google.com";
 if (sheetClient.connect(host, 443)) {
 const String url = String() +"https://"+host+"/macros/s/"+asId+"/exec?type=insert&dateInclude="+dateInclude+"&sheetId="+sheetId+"&sheetTag="+sheetTag+"&data="+data;
 sheetClient.println("GET " + url + " HTTP/1.1");
 sheetClient.println(String()+"Host: "+host);
 sheetClient.println("Accept: */*");
 sheetClient.println("Connection: close");
 sheetClient.println();
 sheetClient.println();
 sheetClient.stop();
 }
}

// --------google sheet write data subroutine--------------- usually happen on void Loop()


void writeGoogleSheet() {
 sendToGoogleSheets("1",URLEncode((String() + fakePressure).c_str())); //sending pressure data to google sheet with time stamp(google)
}

String URLEncode(const char* msg)
{
 const char *hex = "0123456789abcdef";
 String encodedMsg = "";
 while (*msg!='\0'){
 if( ('a' <= *msg && *msg <= 'z')
 || ('A' <= *msg && *msg <= 'Z')
 || ('0' <= *msg && *msg <= '9') ) {
 encodedMsg += *msg;
 } else {
 encodedMsg += '%';
 encodedMsg += hex[*msg >> 4];
 encodedMsg += hex[*msg & 15];
 }
 msg++;
 }
 return encodedMsg;
}



// -------- subroutines (function)---------------

//========================================
void getPresureData(){

  //not done yet
  
  if(currentMillis-previousPressureMillis >= pressureInterval){
    fakePressure=random(3000);//fake data for testing
    previousPressureMillis=currentMillis;
    Serial.print("get pressure Data;");
    Serial.println(fakePressure);
  }
  
}



//========================================
void pressureSendGoogleSheet(){
  if(currentMillis-previousSendGoogle >= sendGoogleInterval){
    Serial.println("sending Google sheet;");
    writeGoogleSheet();
    Serial.println("done!");
    previousSendGoogle=currentMillis;    
 }
 
}



// -------- arduino main routine (function)---------------
//========================================

void setup()
{
 wifiSetting();
 googleSheetSetting();
 Serial.begin(9600);
 delay(1000);
 Serial.println("");
 Serial.println("program start");

}


//========================================

void loop()
{
  

      // Notice that none of the action happens in loop() apart from reading millis()
      //   it just calls the functions that have the action code

  currentMillis = millis();   // capture the latest value of millis()
                              //   this is equivalent to noting the time from a clock
                              //   use the same time for all LED flashes to keep them synchronized
  getPresureData();
  pressureSendGoogleSheet();
  delay(0); // feed watch dog

}
